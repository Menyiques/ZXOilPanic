sub fastcall sound(a as ubyte)
asm
;BeepFX player by Shiru
;You are free to do whatever you want with this code



playBasic:
	
play:
	ld hl,sfxData	;address of sound effects data

	di
	push ix
	push iy

	ld b,0
	ld c,a
	add hl,bc
	add hl,bc
	ld e,(hl)
	inc hl
	ld d,(hl)
	push de
	pop ix			;put it into ix

	ld a,(23624)	;get border color from BASIC vars to keep it unchanged
	rra
	rra
	rra
	and 7
	ld (sfxRoutineToneBorder  +1),a
	ld (sfxRoutineNoiseBorder +1),a
	ld (sfxRoutineSampleBorder+1),a


readData:
	ld a,(ix+0)		;read block type
	ld c,(ix+1)		;read duration 1
	ld b,(ix+2)
	ld e,(ix+3)		;read duration 2
	ld d,(ix+4)
	push de
	pop iy

	dec a
	jr z,sfxRoutineTone
	dec a
	jr z,sfxRoutineNoise
	dec a
	jr z,sfxRoutineSample
	pop iy
	pop ix
	ei
	ret

	

;play sample

sfxRoutineSample:
	ex de,hl
sfxRS0:
	ld e,8
	ld d,(hl)
	inc hl
sfxRS1:
	ld a,(ix+5)
sfxRS2:
	dec a
	jr nz,sfxRS2
	rl d
	sbc a,a
	and 16
sfxRoutineSampleBorder:
	or 0
	out (254),a
	dec e
	jr nz,sfxRS1
	dec bc
	ld a,b
	or c
	jr nz,sfxRS0

	ld c,6
	
nextData:
	add ix,bc		;skip to the next block
	jr readData



;generate tone with many parameters

sfxRoutineTone:
	ld e,(ix+5)		;freq
	ld d,(ix+6)
	ld a,(ix+9)		;duty
	ld (sfxRoutineToneDuty+1),a
	ld hl,0

sfxRT0:
	push bc
	push iy
	pop bc
sfxRT1:
	add hl,de
	ld a,h
sfxRoutineToneDuty:
	cp 0
	sbc a,a
	and 16
sfxRoutineToneBorder:
	or 0
	out (254),a

	dec bc
	ld a,b
	or c
	jr nz,sfxRT1

	ld a,(sfxRoutineToneDuty+1)	 ;duty change
	add a,(ix+10)
	ld (sfxRoutineToneDuty+1),a

	ld c,(ix+7)		;slide
	ld b,(ix+8)
	ex de,hl
	add hl,bc
	ex de,hl

	pop bc
	dec bc
	ld a,b
	or c
	jr nz,sfxRT0

	ld c,11
	jr nextData



;generate noise with two parameters

sfxRoutineNoise:
	ld e,(ix+5)		;pitch

	ld d,1
	ld h,d
	ld l,d
sfxRN0:
	push bc
	push iy
	pop bc
sfxRN1:
	ld a,(hl)
	and 16
sfxRoutineNoiseBorder:
	or 0
	out (254),a
	dec d
	jr nz,sfxRN2
	ld d,e
	inc hl
	ld a,h
	and 31
	ld h,a
sfxRN2:
	dec bc
	ld a,b
	or c
	jr nz,sfxRN1

	ld a,e
	add a,(ix+6)	;slide
	ld e,a

	pop bc
	dec bc
	ld a,b
	or c
	jr nz,sfxRN0

	ld c,7
	jr nextData


sfxData:

SoundEffectsData:
	defw SoundEffect0Data
	defw SoundEffect1Data
	defw SoundEffect2Data
	defw SoundEffect3Data
	defw SoundEffect4Data

SoundEffect0Data:
	defb 3 ;sample
	defw 195
	defw Sample0Data+0
	defb 1
	defb 0
SoundEffect1Data:
	defb 3 ;sample
	defw 119
	defw Sample1Data+0
	defb 1
	defb 0
SoundEffect2Data:
	defb 3 ;sample
	defw 76
	defw Sample2Data+0
	defb 1
	defb 0
SoundEffect3Data:
	defb 3 ;sample
	defw 72
	defw Sample3Data+0
	defb 1
	defb 0
SoundEffect4Data:
	defb 3 ;sample
	defw 1267
	defw Sample4Data+0
	defb 1
	defb 0

Sample0Data:
	defb 255,255,255,255,255,255,255,255,255,255,255,255,255,255,129,240
	defb 126,15,252,255,159,227,255,248,63,7,225,255,143,241,254,127
	defb 255,135,224,252,31,249,255,63,199,255,240,126,31,195,255,63
	defb 231,252,255,255,15,193,248,63,243,254,127,143,255,225,252,63
	defb 135,254,127,207,249,255,252,31,131,240,255,231,249,255,63,255
	defb 195,248,127,15,252,255,159,243,255,255,255,15,225,252,63,243
	defb 254,127,207,255,240,252,31,135,255,63,231,249,255,254,31,195
	defb 248,127,231,252,255,159,255,225,248,127,15,254,127,159,243,255
	defb 252,63,135,240,255,207,249,255,63,255,131,240,254,31,252,255
	defb 63,231,255,248,127,15,193,255,159,243,254,127,255,15,225,252
	defb 63,241,254,127,207,255,255,255,255,255,255,255,255,255,255,255
	defb 255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
	defb 255,255,255

Sample1Data:
	defb 255,255,255,255,255,252,120,31,7,255,255,255,241,224,124,31
	defb 255,255,255,207,129,240,255,255,255,255,62,7,195,255,255,255
	defb 252,248,31,15,255,255,255,243,224,124,63,255,255,255,207,131
	defb 224,255,255,255,254,60,15,131,255,255,255,248,240,62,15,255
	defb 255,255,231,192,248,63,255,255,255,159,3,225,255,255,255,254
	defb 124,15,135,255,255,255,249,240,62,31,255,255,255,231,192,248
	defb 127,255,255,255,159,7,225,255,255,255,254,124,31,135,255,255
	defb 255,255,255,255,255,255,255

Sample2Data:
	defb 255,255,193,248,15,255,193,248,15,255,224,252,15,255,224,252
	defb 15,255,240,252,7,255,240,126,7,255,240,126,7,255,248,126
	defb 7,255,248,127,3,255,252,63,3,255,252,63,131,255,252,63
	defb 129,255,254,31,129,255,254,31,193,255,254,31,192,255,255,15
	defb 192,255,255,255,255,255,255,255,255,255,255,255

Sample3Data:
	defb 255,255,255,255,255,241,224,124,15,129,224,60,15,129,240,62
	defb 7,129,240,62,7,192,248,62,7,192,248,31,7,224,248,31
	defb 3,224,252,31,131,224,124,31,131,240,126,15,131,240,126,15
	defb 193,240,62,15,193,248,63,7,193,248,63,7,224,252,63,7
	defb 239,255,255,255,255,255,255,255

Sample4Data:
	defb 126,15,193,240,60,15,255,255,255,255,255,255,248,127,15,255
	defb 255,255,193,248,63,7,192,252,31,131,240,124,31,135,255,255
	defb 255,255,255,255,255,223,247,255,255,193,240,62,15,129,248,63
	defb 7,192,248,62,7,255,255,255,255,255,255,255,255,255,255,255
	defb 227,240,124,31,131,224,126,15,129,240,62,15,131,255,255,255
	defb 255,255,255,255,255,255,255,255,240,248,31,7,224,248,31,3
	defb 224,124,31,3,255,255,255,255,255,255,255,255,255,255,255,255
	defb 240,62,7,192,248,62,7,192,248,31,7,225,255,255,255,255
	defb 255,255,255,255,255,255,255,248,124,15,129,240,62,7,193,240
	defb 62,7,192,248,63,7,255,255,255,255,255,255,255,255,240,252
	defb 31,3,224,124,15,131,240,124,15,129,255,255,255,255,255,255
	defb 255,255,255,255,255,255,248,31,7,192,248,31,3,224,252,31
	defb 3,225,255,255,255,255,255,255,255,255,255,255,255,248,62,7
	defb 193,240,62,7,192,248,63,7,192,255,255,255,255,255,255,255
	defb 255,255,255,255,255,252,15,129,240,124,15,129,240,62,15,193
	defb 248,127,255,255,255,255,255,255,255,255,255,255,254,31,3,224
	defb 124,31,3,224,124,15,131,240,127,255,255,255,255,255,255,255
	defb 255,255,255,255,254,7,192,248,31,7,192,248,31,3,224,252
	defb 63,255,255,255,255,255,255,255,255,255,255,255,15,129,240,62
	defb 7,193,240,62,7,192,248,63,255,255,255,255,255,255,255,255
	defb 255,255,255,255,3,224,124,15,129,240,124,15,129,240,62,15
	defb 193,248,255,255,255,255,255,255,255,255,255,135,192,248,31,3
	defb 224,124,31,131,224,124,15,255,255,255,255,255,255,255,255,255
	defb 255,255,255,128,240,62,7,192,248,63,7,192,248,31,15,255
	defb 255,255,255,255,255,255,255,255,255,255,193,240,60,15,129,240
	defb 62,15,193,240,62,7,255,255,255,255,255,255,255,255,255,255
	defb 255,255,224,124,15,3,224,124,15,131,240,124,15,135,255,255
	defb 255,255,255,255,255,255,255,255,255,224,248,31,3,192,248,31
	defb 3,224,124,31,131,255,255,255,255,255,255,255,255,255,255,255
	defb 255,240,62,7,193,240,62,7,192,248,63,7,225,255,255,255
	defb 255,255,255,255,255,255,255,255,248,124,15,129,240,124,15,129
	defb 240,62,15,193,255,255,255,255,255,255,255,255,255,255,255,255
	defb 248,31,3,224,124,31,3,224,124,15,131,240,124,15,135,255
	defb 255,255,255,255,255,255,255,255,254,7,192,248,31,7,192,248
	defb 31,3,224,252,63,255,255,255,255,255,255,255,255,255,255,255
	defb 15,129,240,62,7,193,248,62,7,193,248,63,255,255,255,255
	defb 255,255,255,255,255,255,255,255,3,224,124,15,129,240,124,15
	defb 129,240,62,31,255,255,255,255,255,255,255,255,255,255,255,135
	defb 192,248,31,3,224,124,31,131,224,124,15,255,255,255,255,255
	defb 255,255,255,255,255,255,255,192,240,62,7,192,248,31,7,192
	defb 248,31,15,255,255,255,255,255,255,255,255,255,255,255,193,240
	defb 60,15,129,240,62,15,193,240,62,7,255,255,255,255,255,255
	defb 255,255,255,255,255,255,224,124,15,3,224,124,15,129,240,124
	defb 15,135,255,255,255,255,255,255,255,255,255,255,255,224,248,31
	defb 3,192,248,31,3,224,124,31,131,224,124,15,255,255,255,255
	defb 255,255,255,255,255,255,254,7,193,248,62,7,192,248,63,7
	defb 192,248,127,255,255,255,255,255,255,255,255,255,255,254,15,129
	defb 240,126,15,129,240,62,7,193,240,63,255,255,255,255,255,255
	defb 255,255,255,255,255,255,3,224,124,31,3,224,124,15,129,240
	defb 126,31,255,255,255,255,255,255,255,255,255,255,255,135,192,248
	defb 31,7,192,248,31,3,224,124,31,255,255,255,255,255,255,255
	defb 255,255,255,255,255,129,240,62,7,193,240,62,7,192,248,63
	defb 15,255,255,255,255,255,255,255,255,255,255,255,195,224,124,15
	defb 129,240,124,15,129,240,62,7,255,255,255,255,255,255,255,255
	defb 255,255,255,255,192,248,31,3,224,124,31,131,224,124,15,135
	defb 255,255,255,255,255,255,255,255,255,255,255,225,240,62,7,192
	defb 248,31,7,192,248,31,3,224,252,31,255,255,255,255,255,255
	defb 255,255,255,255,255,15,129,240,62,7,193,248,62,7,192,248
	defb 63,255,255,255,255,255,255,255,255,255,255,255,255,3,224,124
	defb 15,129,240,124,15,129,240,62,31,255,255,255,255,255,255,255
	defb 255,255,255,255,135,224,248,31,3,224,252,31,3,224,124,15
	defb 255,255,255,255,255,255,255,255,255,255,255,255,192,240,62,7
	defb 192,248,31,7,192,248,31,15,255,255,255,255,255,255,255,255
	defb 255,255,255,193,240,60,15,129,240,62,7,193,248,62,7,255
	defb 255,255,255,255,255,255,255,255,255,255,255,224,124,15,3,224
	defb 124,15,131,240,124,15,135,255,255,255,255,255,255,255,255,255
	defb 255,255,224,248,31,3,224,248,31,3,224,124,31,131,255,255
	defb 255,255,255,255,255,255,255,255,255,255,240,62,7,192,240,62
	defb 7,192,248,31,7,224,248,31,15,255,255,255,255,255,255,255
	defb 255,255,255,255,193,240,60,15,129,240,62,15,193,240,62,7
	defb 255,255,255,255,255,255,255,255,255,255,255,255,224,124,31,3
	defb 224,124,15,129,240,124,15,135,255,255,255,255,255,255,255,255
	defb 255,255,255,224,248,31,7,192,248,31,3,224,124,31,3,255
	defb 255,255,255,255,255,255,255,255,255,255,255,240,62,7,192,240
	defb 62,7,192,248,31,7,225,255,255,255,255,255,255,255,255,255
	defb 255,255,248,124,15,129,240,124,15,129,240,62,15,193,255,255
	defb 255,255,255,255,255,255,255,255,255,255,248,31,3,224,124,31
	defb 3,224,124,15,131,240,255,255,255,255,255,255,255,255,255,255
	defb 255,252,62,7,192,248,31,7,192,248,31,3,224,255,255,255
	defb 255,255,253
end asm
end sub